<!DOCTYPE html>
<meta charset="utf-8">

<head>

	<script type="text/javascript" src="../../src/d3.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/NickQiZhu/dc.js/master/web/js/crossfilter.js"></script>

<style>


</style>

</head>

<body>
  
  <h1> Les sites media français</h1>
  
  <p id="chart">
  
  <p id="theme" class="selector"><b>Thématique du site</b><br><select> </select>
    
  <div id="audience" class="selector"><b>Audience</b><br>
      <input id="min" placeholder="min"> </input> 
      <input id="max" placeholder="max"> </input>
      <button> Go </button>
  </div>
  
  <p><button id="resetAll">filter All </button>
    
  

	<script type="text/javascript">

var margin = {top: 20, right: 40, bottom: 10, left: 40},
    width = 960,
    height = 500 - margin.top - margin.bottom;

var chartData,
    theme,
    themes,
    audience,
    extent;

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x = d3.scale.ordinal().rangeRoundBands([0, width], .1),
    y = d3.scale.linear().range([height,0]),
    color = d3.scale.category10();

d3.select("#resetAll")
.on("click",updatedata);

d3.select("#theme select")
.on("change",function() {updatedata("theme", d3.select(this).property("value"))});

d3.select("#audience button")
.on("click", function() {updatedata("audience", [parseFloat(d3.select("#min").property("value")),parseFloat(d3.select("#max").property("value"))] )});

d3.csv("../sets/sitesmedia.csv",function(csv) {
  
  // Créer la visusalisation 

  themes = Object.keys(d3.nest()
    .key(function(d){
      return d.theme;
    })
    .map(csv));

  themes.unshift('-');

  x.domain(themes);

  console.log(themes);

  d3.select('#theme select')
    .selectAll('option')
    .data(themes).enter().append('option').text(function(d){
    return d;
  });

  extent = d3.extent(csv, function(d) { return parseFloat(d.visites); });

  y.domain(extent);

  media = crossfilter(csv);

  theme = media.dimension(function(d) { return d.theme; });
  audience = media.dimension(function(d) { return parseFloat(d.visites); });
  
  // data = media.groupAll().reduceSum(function(d) { return d; });

  updatedata();

});

function updatedata(value, selection) {
    console.log("updateData", value, selection);
  
    switch(value) {
      case 'theme':
        if ( selection === '-' )
          theme.filterAll();
        else
          theme.filter(selection);
      break;
      case 'audience':
        console.log(selection);
        if ( ! selection[0]  )
          selection[0] = extent[0];
        if ( ! selection[1]  )
          selection[1] = extent[1];
        console.log(selection);
        audience.filterRange(selection);
      break;
      default:
        audience.filterAll();
        theme.filterAll();
      break;
    };

    chartData = audience.top(Infinity);

    drawScatter();
}

function drawScatter() {

  var bind = svg.selectAll('circle').data(chartData, function(d) { return d.nom; });

  var bindEnter = bind.enter()
    .append('circle')
    .attr('r', 5)
    .attr('fill', function(d) { return color(d.theme); })
    .attr('cx', function(d) { return x(d.theme); })
    .attr('cy', function(d) { return y(d.visites); })
  ;

  var bindExit = bind.exit()
    .remove()
  ;

}

	</script>

</body>
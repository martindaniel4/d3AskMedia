<!DOCTYPE html>
<meta charset="utf-8">

<head>

	<script type="text/javascript" src="../../src/d3.js"></script>
  <script type="text/javascript" src="https://rawgithub.com/NickQiZhu/dc.js/master/web/js/crossfilter.js"></script>

<style>


</style>

</head>

<body>
  
  <h1> Les sites media français</h1>
  
  <p id="chart">
  
  <p id="theme" class="selector"><b>Thématique du site</b><br><select> </select>
    
  <div id="audience" class="selector"><b>Audience</b><br>
      <input id="min" placeholder="min"> </input> 
      <input id="max" placeholder="max"> </input>
      <button> Go </button>
  </div>
  
  <p><button id="resetAll">filter All </button>
    
  

	<script type="text/javascript">

var margin = {top: 20, right: 40, bottom: 10, left: 40},
    width = 960,
    height = 500 - margin.top - margin.bottom;

var charData,
    chartDataAll,
    theme,
    type,
    titres;

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var x = d3.scale.ordinal().rangeRoundBands([0, width], .1),
    y = d3.scale.linear().range([height,0]),
    color = d3.scale.category10();

d3.select("#resetAll")
.on("click",updatedata);

d3.select("#theme select")
.on("change",function() {updatedata("theme",d3.select(this).property("value"))});

d3.select("#audience button")
.on("click", function() {updatedata("audience",[parseFloat(d3.select("#min").property("value")),parseFloat(d3.select("#max").property("value"))] )});

d3.csv("../sets/sitesmedia.csv",function(csv) {
  
  // Crossfilter
  
  chartData = crossfilter(csv);
  
  theme = chartData.dimension(function(d) {return d.theme;}),
  audience = chartData.dimension(function(d) {return parseFloat(d.visites);});
  
  // Nesting and filters 
  
  var themeNest = d3.nest().key(function(d) {return d.theme;}).map(csv);
    
d3.select("#theme select").selectAll("option")
    .data(Object.keys(themeNest))
  .enter().append("option")
    .text(String);
        
  // Update scales domains
    
    x.domain(Object.keys(themeNest));
    
    y.domain(d3.extent(csv, function(d) {return parseFloat(d.visites);}));
    
    updatedata();
  
});

function updatedata(value, selection) {
    
  console.log(selection);
    
  switch (value) {
    
  case "audience": 
    audience.filterRange(selection);
  break;
  
  case "theme":
    theme.filter(selection);
  break;
  
  default:
    theme.filterAll();
    audience.filterAll();

  }
  
  titres =  theme.top(Infinity); // convention pour pouvoir récupérer l'ensemble des éléments
 
  drawScatter();
      
}

function drawScatter() {
  
circles = svg.selectAll(".journal").data(titres, function(d) {return d.nom;});
  
circlesEnter = circles.enter().append("g")
.attr("transform", function(d,i) { return "translate("+x(d.theme)+"," + y(parseFloat(d.visites)) + ")"; })
.attr("class","journal")
.on("mouseover",function() {d3.select(this).select("text").attr("style","display:block;")})
.on("mouseout",function() {d3.select(this).select("text").attr("style","display:none;")});

circlesEnter.append("text")
  .text(function(d) {return d.nom;})
  .attr("style","display:none;")

circlesEnter.append("circle")
  .attr("r",5)
  .attr("fill", function(d) {return color(d.theme);})
  .attr("opacity",0.5)
  
circles
.attr("transform", function(d,i) { return "translate("+x(d.theme)+"," + y(parseFloat(d.visites)) + ")"; });

circles.exit().remove();


}

	</script>

</body>